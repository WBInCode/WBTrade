generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String             @id @default(cuid())
  email                      String             @unique
  password                   String?
  firstName                  String             @map("first_name")
  lastName                   String             @map("last_name")
  phone                      String?
  role                       UserRole           @default(CUSTOMER)
  isActive                   Boolean            @default(true) @map("is_active")
  createdAt                  DateTime           @default(now()) @map("created_at")
  updatedAt                  DateTime           @updatedAt @map("updated_at")
  emailVerified              Boolean            @default(false) @map("email_verified")
  emailVerifiedAt            DateTime?          @map("email_verified_at")
  failedLoginAttempts        Int                @default(0) @map("failed_login_attempts")
  lastLoginAt                DateTime?          @map("last_login_at")
  lastLoginIp                String?            @map("last_login_ip")
  lockedUntil                DateTime?          @map("locked_until")
  passwordChangedAt          DateTime?          @map("password_changed_at")
  email_verification_expires DateTime?
  email_verification_token   String?            @unique
  // OAuth fields
  authProvider               AuthProvider       @default(LOCAL) @map("auth_provider")
  googleId                   String?            @unique @map("google_id")
  avatarUrl                  String?            @map("avatar_url")
  addresses                  Address[]
  cart                       Cart?
  orders                     Order[]
  reviews                    Review[]
  searchHistory              SearchHistory[]
  auditLogs                  SecurityAuditLog[]
  wishlistItems              WishlistItem[]

  @@map("users")
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

model Address {
  id             String      @id @default(cuid())
  userId         String?     @map("user_id")
  firstName      String      @map("first_name")
  lastName       String      @map("last_name")
  companyName    String?     @map("company_name")
  nip            String?
  street         String
  city           String
  postalCode     String      @map("postal_code")
  country        String      @default("PL")
  phone          String?
  isDefault      Boolean     @default(false) @map("is_default")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  label          String?
  type           AddressType @default(SHIPPING)
  user           User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  billingOrders  Order[]     @relation("BillingAddress")
  shippingOrders Order[]     @relation("ShippingAddress")

  @@index([userId])
  @@index([userId, type])
  @@map("addresses")
}

model Category {
  id                     String          @id @default(cuid())
  name                   String
  slug                   String          @unique
  parentId               String?         @map("parent_id")
  image                  String?
  order                  Int             @default(0)
  isActive               Boolean         @default(true) @map("is_active")
  createdAt              DateTime        @default(now()) @map("created_at")
  updatedAt              DateTime        @updatedAt @map("updated_at")
  baselinkerCategoryId   String?         @unique @map("baselinker_category_id")
  baselinkerCategoryPath String?         @map("baselinker_category_path") // Pełna ścieżka z Baselinker np. "Gastronomia|Naczynia i przybory kuchenne"
  parent                 Category?       @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children               Category[]      @relation("CategoryHierarchy")
  products               Product[]
  searchHistory          SearchHistory[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Product {
  id                     String           @id @default(cuid())
  name                   String
  slug                   String           @unique
  description            String?
  sku                    String           @unique
  barcode                String?
  status                 ProductStatus    @default(DRAFT)
  price                  Decimal          @db.Decimal(10, 2)
  compareAtPrice         Decimal?         @map("compare_at_price") @db.Decimal(10, 2)
  // Omnibus: najniższa cena z ostatnich 30 dni (rolling window UTC)
  lowestPrice30Days      Decimal?         @map("lowest_price_30_days") @db.Decimal(10, 2)
  lowestPrice30DaysAt    DateTime?        @map("lowest_price_30_days_at")
  metaTitle              String?          @map("meta_title")
  metaDescription        String?          @map("meta_description")
  createdAt              DateTime         @default(now()) @map("created_at")
  updatedAt              DateTime         @updatedAt @map("updated_at")
  categoryId             String?          @map("category_id")
  specifications         Json?            @default("{}")
  baselinkerProductId    String?          @unique @map("baselinker_product_id")
  baselinkerCategoryPath String?          @map("baselinker_category_path")
  average_rating         Decimal?         @db.Decimal(2, 1)
  review_count           Int              @default(0)
  tags                   String[]         @default([])
  // Popularity tracking
  viewCount              Int              @default(0) @map("view_count")
  salesCount             Int              @default(0) @map("sales_count")
  popularityScore        Float            @default(0) @map("popularity_score")
  images                 ProductImage[]
  variants               ProductVariant[]
  priceHistory           PriceHistory[]
  category               Category?        @relation(fields: [categoryId], references: [id])
  reviews                Review[]
  wishlistItems          WishlistItem[]

  @@index([slug])
  @@index([sku])
  @@index([status])
  @@index([categoryId])
  @@map("products")
}

model Review {
  id                 String        @id @default(cuid())
  userId             String        @map("user_id")
  productId          String        @map("product_id")
  orderId            String?       @map("order_id")
  rating             Int
  title              String?
  content            String
  isVerifiedPurchase Boolean       @default(false) @map("is_verified_purchase")
  isApproved         Boolean       @default(true) @map("is_approved")
  helpfulCount       Int           @default(0) @map("helpful_count")
  notHelpfulCount    Int           @default(0) @map("not_helpful_count")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")
  images             ReviewImage[]
  product            Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

model ReviewImage {
  id        String   @id @default(cuid())
  reviewId  String   @map("review_id")
  url       String
  alt       String?
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@map("review_images")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String   @map("product_id")
  url       String
  alt       String?
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

model ProductVariant {
  id                  String          @id @default(cuid())
  productId           String          @map("product_id")
  name                String
  sku                 String          @unique
  barcode             String?
  price               Decimal         @db.Decimal(10, 2)
  compareAtPrice      Decimal?        @map("compare_at_price") @db.Decimal(10, 2)
  // Omnibus: najniższa cena z ostatnich 30 dni per wariant (rolling window UTC)
  lowestPrice30Days   Decimal?        @map("lowest_price_30_days") @db.Decimal(10, 2)
  lowestPrice30DaysAt DateTime?       @map("lowest_price_30_days_at")
  attributes          Json            @default("{}")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  baselinkerVariantId String?         @unique @map("baselinker_variant_id")
  cartItems           CartItem[]
  inventory           Inventory[]
  orderItems          OrderItem[]
  priceHistory        PriceHistory[]
  product             Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  stockMovements      StockMovement[]
  wishlistItems       WishlistItem[]

  @@index([productId])
  @@index([sku])
  @@index([barcode])
  @@map("product_variants")
}

model Location {
  id                 String          @id @default(cuid())
  name               String
  code               String          @unique
  type               LocationType    @default(WAREHOUSE)
  parentId           String?         @map("parent_id")
  isActive           Boolean         @default(true) @map("is_active")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  inventory          Inventory[]
  parent             Location?       @relation("LocationHierarchy", fields: [parentId], references: [id])
  children           Location[]      @relation("LocationHierarchy")
  stockMovementsFrom StockMovement[] @relation("FromLocation")
  stockMovementsTo   StockMovement[] @relation("ToLocation")

  @@index([code])
  @@map("locations")
}

model Inventory {
  id         String         @id @default(cuid())
  variantId  String         @map("variant_id")
  locationId String         @map("location_id")
  quantity   Int            @default(0)
  reserved   Int            @default(0)
  minimum    Int            @default(0)
  updatedAt  DateTime       @updatedAt @map("updated_at")
  location   Location       @relation(fields: [locationId], references: [id])
  variant    ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, locationId])
  @@index([variantId])
  @@index([locationId])
  @@map("inventory")
}

model StockMovement {
  id             String            @id @default(cuid())
  variantId      String            @map("variant_id")
  type           StockMovementType
  quantity       Int
  fromLocationId String?           @map("from_location_id")
  toLocationId   String?           @map("to_location_id")
  reference      String?
  notes          String?
  createdAt      DateTime          @default(now()) @map("created_at")
  createdBy      String?           @map("created_by")
  fromLocation   Location?         @relation("FromLocation", fields: [fromLocationId], references: [id])
  toLocation     Location?         @relation("ToLocation", fields: [toLocationId], references: [id])
  variant        ProductVariant    @relation(fields: [variantId], references: [id])

  @@index([variantId])
  @@index([type])
  @@index([createdAt])
  @@map("stock_movements")
}

model Cart {
  id         String     @id @default(cuid())
  userId     String?    @unique @map("user_id")
  sessionId  String?    @unique @map("session_id")
  couponCode String?    @map("coupon_code")
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  expiresAt  DateTime?  @map("expires_at")
  items      CartItem[]
  user       User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("carts")
}

model CartItem {
  id        String         @id @default(cuid())
  cartId    String         @map("cart_id")
  variantId String         @map("variant_id")
  quantity  Int            @default(1)
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
  cart      Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([cartId, variantId])
  @@index([cartId])
  @@map("cart_items")
}

model Order {
  id                  String               @id @default(cuid())
  orderNumber         String               @unique @map("order_number")
  userId              String?              @map("user_id")
  status              OrderStatus          @default(PENDING)
  shippingAddressId   String?              @map("shipping_address_id")
  billingAddressId    String?              @map("billing_address_id")
  shippingMethod      String               @map("shipping_method")
  paymentMethod       String               @map("payment_method")
  paymentStatus       PaymentStatus        @default(PENDING) @map("payment_status")
  subtotal            Decimal              @db.Decimal(10, 2)
  discount            Decimal              @default(0) @db.Decimal(10, 2)
  shipping            Decimal              @default(0) @db.Decimal(10, 2)
  tax                 Decimal              @default(0) @db.Decimal(10, 2)
  total               Decimal              @db.Decimal(10, 2)
  trackingNumber      String?              @map("tracking_number")
  customerNotes       String?              @map("customer_notes")
  internalNotes       String?              @map("internal_notes")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  paczkomatAddress    String?              @map("paczkomat_address")
  paczkomatCode       String?              @map("paczkomat_code")
  packageShipping     Json?                @map("package_shipping")
  baselinkerOrderId   String?              @unique @map("baselinker_order_id")
  baselinkerSyncedAt  DateTime?            @map("baselinker_synced_at")
  // Guest checkout fields (used when userId is null)
  guestEmail          String?              @map("guest_email")
  guestFirstName      String?              @map("guest_first_name")
  guestLastName       String?              @map("guest_last_name")
  guestPhone          String?              @map("guest_phone")
  items               OrderItem[]
  statusHistory       OrderStatusHistory[]
  billingAddress      Address?             @relation("BillingAddress", fields: [billingAddressId], references: [id])
  shippingAddress     Address?             @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  user                User?                @relation(fields: [userId], references: [id])

  @@index([orderNumber])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id          String         @id @default(cuid())
  orderId     String         @map("order_id")
  variantId   String         @map("variant_id")
  productName String         @map("product_name")
  variantName String         @map("variant_name")
  sku         String
  quantity    Int
  unitPrice   Decimal        @map("unit_price") @db.Decimal(10, 2)
  total       Decimal        @db.Decimal(10, 2)
  createdAt   DateTime       @default(now()) @map("created_at")
  order       Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant     ProductVariant @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String      @map("order_id")
  status    OrderStatus
  note      String?
  createdAt DateTime    @default(now()) @map("created_at")
  createdBy String?     @map("created_by")
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_status_history")
}

model Coupon {
  id            String       @id @default(cuid())
  code          String       @unique
  description   String?
  type          CouponType   @default(PERCENTAGE)
  value         Decimal      @db.Decimal(10, 2)
  minimumAmount Decimal?     @map("minimum_amount") @db.Decimal(10, 2)
  maximumUses   Int?         @map("maximum_uses")
  usedCount     Int          @default(0) @map("used_count")
  startsAt      DateTime?    @map("starts_at")
  expiresAt     DateTime?    @map("expires_at")
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  // Welcome discount - coupon generated for specific user on registration
  userId        String?      @map("user_id")
  couponSource  CouponSource @default(MANUAL)

  @@index([code])
  @@index([userId])
  @@map("coupons")
}

// Source of coupon creation
enum CouponSource {
  MANUAL           // Admin created
  WELCOME_DISCOUNT // Auto-generated on registration (-20%)
  REFERRAL         // Referral program (future)
  CAMPAIGN         // Marketing campaign
}

model TaxRate {
  id        String   @id @default(cuid())
  name      String
  rate      Decimal  @db.Decimal(5, 2)
  country   String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([country])
  @@map("tax_rates")
}

model SecurityAuditLog {
  id        String   @id @default(cuid())
  action    String
  userId    String?  @map("user_id")
  email     String?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  metadata  String?
  severity  String   @default("INFO")
  success   Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([email])
  @@index([action])
  @@index([createdAt])
  @@index([ipAddress])
  @@map("security_audit_logs")
}

model RefreshToken {
  id         String    @id @default(cuid())
  token      String    @unique
  userId     String    @map("user_id")
  deviceInfo String?   @map("device_info")
  ipAddress  String?   @map("ip_address")
  expiresAt  DateTime  @map("expires_at")
  revokedAt  DateTime? @map("revoked_at")
  replacedBy String?   @map("replaced_by")
  createdAt  DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model WishlistItem {
  id        String          @id @default(cuid())
  userId    String          @map("user_id")
  productId String          @map("product_id")
  variantId String?         @map("variant_id")
  createdAt DateTime        @default(now()) @map("created_at")
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("wishlist_items")
}

model SearchHistory {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  query        String
  categoryId   String?   @map("category_id")
  resultsCount Int       @default(0) @map("results_count")
  createdAt    DateTime  @default(now()) @map("created_at")
  category     Category? @relation(fields: [categoryId], references: [id])
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([query])
  @@index([createdAt])
  @@map("search_history")
}

model BaselinkerConfig {
  id                  String    @id @default(cuid())
  inventoryId         String    @unique @map("inventory_id")
  apiTokenEncrypted   String    @map("api_token_encrypted")
  encryptionIv        String    @map("encryption_iv")
  authTag             String    @map("auth_tag")
  lastSyncAt          DateTime? @map("last_sync_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  syncEnabled         Boolean   @default(false) @map("sync_enabled")
  syncIntervalMinutes Int       @default(60) @map("sync_interval_minutes")

  @@map("baselinker_configs")
}

model BaselinkerSyncLog {
  id             String               @id @default(cuid())
  type           BaselinkerSyncType
  status         BaselinkerSyncStatus
  itemsProcessed Int                  @default(0) @map("items_processed")
  errors         Json?
  startedAt      DateTime             @default(now()) @map("started_at")
  completedAt    DateTime?            @map("completed_at")

  @@index([type])
  @@index([status])
  @@index([startedAt])
  @@map("baselinker_sync_logs")
}

model newsletter_campaigns {
  id              String                   @id
  title           String
  subject         String
  content         String
  status          NewsletterCampaignStatus @default(DRAFT)
  scheduled_for   DateTime?
  sent_at         DateTime?
  recipient_count Int                      @default(0)
  opened_count    Int                      @default(0)
  clicked_count   Int                      @default(0)
  created_at      DateTime                 @default(now())
  updated_at      DateTime

  @@index([sent_at])
  @@index([status])
}

model newsletter_subscriptions {
  id              String    @id
  email           String    @unique
  token           String    @unique
  is_verified     Boolean   @default(false)
  subscribed_at   DateTime  @default(now())
  verified_at     DateTime?
  unsubscribed_at DateTime?

  @@index([email])
  @@index([is_verified])
}

enum UserRole {
  CUSTOMER
  ADMIN
  WAREHOUSE
}

enum AddressType {
  SHIPPING
  BILLING
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum LocationType {
  WAREHOUSE
  ZONE
  SHELF
  BIN
}

enum StockMovementType {
  RECEIVE
  SHIP
  TRANSFER
  ADJUST
  RESERVE
  RELEASE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  OPEN
}

enum PaymentStatus {
  PENDING
  AWAITING_CONFIRMATION
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELLED
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum BaselinkerSyncType {
  PRODUCTS
  CATEGORIES
  STOCK
  IMAGES
}

enum BaselinkerSyncStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum NewsletterCampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

// ============================================
// OMNIBUS: Źródło zmiany ceny (audit trail)
// ============================================
enum PriceChangeSource {
  ADMIN       // Zmiana przez panel administracyjny
  API         // Zmiana przez REST API
  BASELINKER  // Synchronizacja z BaseLinker
  IMPORT      // Import CSV/XLSX
  SCRIPT      // Ręczny skrypt
  SYSTEM      // Automatyczna zmiana systemowa
}

// ============================================
// OMNIBUS: Historia cen (Dyrektywa 2019/2161)
// ============================================
// Tabela przechowuje każdą zmianę ceny produktu/wariantu
// Używana do wyliczania "najniższej ceny z ostatnich 30 dni"
// Okno czasowe: rolling 30*24h w strefie UTC
model PriceHistory {
  id          String            @id @default(cuid())
  productId   String            @map("product_id")
  variantId   String?           @map("variant_id")
  oldPrice    Decimal           @map("old_price") @db.Decimal(10, 2)
  newPrice    Decimal           @map("new_price") @db.Decimal(10, 2)
  source      PriceChangeSource
  changedBy   String?           @map("changed_by")  // userId lub null dla SYSTEM/BASELINKER
  reason      String?           // Opcjonalny powód zmiany
  changedAt   DateTime          @default(now()) @map("changed_at")
  
  product     Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant     ProductVariant?   @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  @@index([productId, changedAt])
  @@index([variantId, changedAt])
  @@index([changedAt])
  @@index([source])
  @@map("price_history")
}

// ============================================
// SETTINGS - For admin-configurable options
// ============================================

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}
